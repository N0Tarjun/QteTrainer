<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Squid Game QTE Trainer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
    <style>
        :root {
            --dark-red: #b2071d;
            --light-red: #e50914;
            --light-grey: #f0f0f0;
            --dark-grey: #1a1a1a;
            --neon-blue: #00d4ff;
            --neon-pink: #ff5c8d;
            --neon-green: #00ff00;
            --squid-green: #2f847c;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #0d0d0d;
            color: var(--light-grey);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            flex-direction: column;
            text-align: center;
        }

        /* General UI Elements */
        .container {
            width: 90%;
            max-width: 800px;
            padding: 20px;
            background: rgba(13, 13, 13, 0.7);
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 10;
            border: 1px solid var(--neon-pink);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #main-menu {
            flex-direction: row;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }

        #main-menu .main-menu-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-basis: 50%;
            min-width: 300px;
            box-sizing: border-box;
            padding: 10px;
        }

        #settings-screen, #achievements-screen, #game-modes-screen {
            flex-direction: column;
            justify-content: flex-start;
            text-align: left;
            max-height: 90vh;
            overflow-y: auto;
        }

        h1, h2, h3 {
            color: var(--light-red);
            text-shadow: 0 0 5px var(--neon-pink);
            font-weight: 700;
            margin-top: 0;
        }

        .user-rank {
            font-size: 1.1em;
            color: #ffcc00;
            text-shadow: 0 0 5px #ffcc00;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .high-streak-glow {
            animation: streakGlow 1s infinite alternate;
        }

        @keyframes streakGlow {
            0% { text-shadow: 0 0 5px var(--neon-pink); }
            100% { text-shadow: 0 0 20px var(--neon-pink), 0 0 30px var(--neon-pink); }
        }

        #marathon-mode, #memory-mode, #sound-mode {
            text-align: center;
        }

        .game-prompt {
            font-size: 3em;
            margin: 50px 0;
            color: var(--light-grey);
            text-shadow: 0 0 10px var(--neon-pink);
            animation: pulse 1.5s infinite;
        }

        .game-input-field {
            width: 80%;
            max-width: 400px;
            font-size: 2em;
            text-align: center;
            border: 2px solid var(--squid-green);
        }

        .challenge-box {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 250px;
            background: rgba(47, 132, 124, 0.2);
            border: 1px solid var(--squid-green);
            padding: 10px;
            border-radius: 8px;
            z-index: 20;
        }

        .challenge-box h3 {
            color: var(--squid-green);
            text-shadow: none;
            margin: 0 0 5px 0;
        }

        .challenge-box button {
            width: 100%;
            font-size: 0.9em;
            padding: 8px 16px;
            margin-top: 5px;
        }

        .achievements-list {
            list-style: none;
            padding: 0;
            width: 100%;
        }

        .achievement-item {
            display: flex;
            align-items: center;
            background: rgba(47, 132, 124, 0.1);
            border: 1px solid rgba(47, 132, 124, 0.5);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .achievement-item.unlocked {
            background: rgba(0, 255, 0, 0.1);
            border-color: var(--neon-green);
            color: var(--neon-green);
        }

        .achievement-item .icon {
            font-size: 2em;
            margin-right: 15px;
        }
        
        .achievement-item .icon.unlocked {
            color: var(--neon-green);
        }
        
        .achievement-item .details h4 {
            margin: 0;
            color: var(--light-grey);
            text-shadow: none;
        }
        
        .achievement-item .details p {
            margin: 5px 0 0;
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        .game-stats {
            margin-top: 20px;
            width: 100%;
            display: flex;
            justify-content: space-around;
        }
        
        .game-stats .stat-item {
            text-align: center;
        }

        .game-stats .stat-item p {
            font-size: 1em;
            margin: 0;
        }
        
        .game-stats .stat-item span {
            font-size: 1.5em;
            font-weight: bold;
        }

        .score-stat { color: var(--light-red); text-shadow: 0 0 5px var(--light-red); }
        .streak-stat { color: var(--neon-pink); text-shadow: 0 0 5px var(--neon-pink); }
        .accuracy-stat { color: var(--squid-green); text-shadow: 0 0 5px var(--squid-green); }

        .player-color-picker {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .color-box {
            width: 30px;
            height: 30px;
            border: 2px solid var(--light-grey);
            cursor: pointer;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        
        .color-box.selected {
            transform: scale(1.2);
            box-shadow: 0 0 10px var(--neon-pink);
        }

        button {
            background-color: var(--squid-green);
            color: var(--light-grey);
            border: 2px solid var(--neon-pink);
            padding: 12px 24px;
            margin: 10px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s;
            box-shadow: 0 0 10px var(--neon-pink);
            display: flex;
            align-items: center;
            gap: 10px;
            width: 250px;
            justify-content: center;
        }

        button:hover {
            background-color: var(--neon-pink);
            transform: translateY(-2px);
            box-shadow: 0 0 15px var(--neon-pink);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 0 5px var(--neon-pink);
        }

        .icon-circle-soldier { position: relative; width: 24px; height: 24px; }
        .icon-circle-soldier::before { content: '\f111'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 1.5em; color: var(--neon-pink); position: absolute; top: 0; left: 0; }
        .icon-circle-soldier::after { content: '\f05b'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 0.8em; color: var(--dark-grey); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .icon-front-man { position: relative; width: 24px; height: 24px; }
        .icon-front-man::before { content: '\f6ed'; font-family: 'Font Awesome 6 Free'; font-weight: 900; font-size: 1.5em; color: var(--dark-grey); position: absolute; top: 0; left: 0; }
        .icon-front-man::after { content: ''; position: absolute; width: 100%; height: 100%; border: 2px solid var(--neon-pink); border-radius: 4px; top: 0; left: 0; }
        input[type="text"], input[type="number"], select, input[type="range"] {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border-radius: 8px;
            border: 1px solid var(--squid-green);
            background-color: var(--dark-grey);
            color: var(--light-grey);
            font-size: 1em;
            outline: none;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            border-color: var(--neon-pink);
            box-shadow: 0 0 5px var(--neon-pink);
        }
        .settings-group { display: flex; flex-direction: column; align-items: flex-start; margin: 10px 0; width: 100%; text-align: left; }
        .settings-group label, .settings-group span { flex-grow: 1; text-align: left; margin-right: 10px; width: 100%; }
        .settings-group .setting-control { display: flex; align-items: center; justify-content: space-between; width: 100%; }
        .settings-group .setting-control input, .settings-group .setting-control select { flex-grow: 1; margin-left: 10px; }
        .settings-group input[type="range"] { width: 150px; }
        .toggle-switch { display: flex; align-items: center; justify-content: center; }
        .toggle-switch input[type="checkbox"] { display: none; }
        .toggle-switch label { background-color: var(--dark-grey); width: 60px; height: 30px; border-radius: 15px; cursor: pointer; position: relative; transition: background-color 0.3s; margin-left: 10px; }
        .toggle-switch label::after { content: ''; position: absolute; width: 26px; height: 26px; border-radius: 50%; background-color: var(--light-grey); top: 2px; left: 2px; transition: transform 0.3s; }
        .toggle-switch input[type="checkbox"]:checked + label { background-color: var(--neon-pink); }
        .toggle-switch input[type="checkbox"]:checked + label::after { transform: translateX(30px); background-color: var(--squid-green); }

        .game-screen { display: none; width: 100%; height: 100%; position: relative; z-index: 5; }
        #classic-mode { text-align: center; }
        #classic-prompt { font-size: 3em; margin: 50px 0; color: var(--light-grey); text-shadow: 0 0 10px var(--neon-pink); animation: pulse 1.5s infinite; }
        #classic-input-field { width: 80%; max-width: 400px; font-size: 2em; text-align: center; border: 2px solid var(--squid-green); }
        #circle-mode { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; background: linear-gradient(45deg, rgba(0, 0, 0, 0.8) 0%, rgba(47, 132, 124, 0.2) 100%); position: relative; }
        #circle-game-area { position: relative; width: 90vmin; height: 90vmin; max-width: 700px; max-height: 700px; border: 2px solid var(--neon-blue); border-radius: 10px; box-shadow: 0 0 20px var(--neon-blue); overflow: hidden; background-color: rgba(0, 0, 0, 0.5); }
        .circle-target { position: absolute; transform: translate(-50%, -50%); display: flex; justify-content: center; align-items: center; flex-direction: column; width: 150px; height: 150px; }
        .outer-circle { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--neon-pink); transition: all linear; }
        .inner-circle { position: absolute; width: 60%; height: 60%; background-color: rgba(229, 9, 20, 0.5); border-radius: 50%; border: 2px solid var(--light-red); transition: background-color 0.2s, border-color 0.2s; }
        .key-button { position: absolute; background-color: var(--neon-pink); color: var(--light-grey); width: 50%; height: 50%; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2.5em; font-weight: bold; box-shadow: 0 0 10px var(--neon-pink); pointer-events: none; }
        .hit-effect { position: absolute; background-color: var(--light-grey); border-radius: 50%; opacity: 0; animation: hitFade 0.5s ease-out; z-index: 10; }
        @keyframes hitFade { 0% { transform: scale(0); opacity: 1; } 100% { transform: scale(1.5); opacity: 0; } }
        .leaderboard-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: rgba(0, 0, 0, 0.5); border-radius: 10px; border: 1px solid var(--neon-pink); }
        .leaderboard-table th, .leaderboard-table td { padding: 12px; border-bottom: 1px solid var(--squid-green); text-align: left; }
        .leaderboard-table th { background-color: var(--dark-red); color: var(--light-grey); font-weight: bold; }
        .leaderboard-table tbody tr:last-child td { border-bottom: none; }
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); justify-content: center; align-items: center; }
        .modal-content { background-color: var(--dark-grey); padding: 20px; border-radius: 15px; width: 90%; max-width: 500px; box-shadow: 0 0 20px var(--neon-pink); position: relative; border: 1px solid var(--squid-green); }
        .close-button { position: absolute; top: 10px; right: 15px; font-size: 2em; cursor: pointer; color: var(--neon-pink); }
        .squid-carousel-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #0d0d0d; z-index: 0; overflow: hidden; }
        .squid-carousel-bg svg { width: 100%; height: 100%; animation: spin 60s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .footer { position: fixed; bottom: 10px; width: 100%; text-align: center; z-index: 10; }
        .footer p { font-size: 0.8em; color: rgba(255, 255, 255, 0.5); }
        .footer p .author { font-weight: bold; color: #ffcc00; }
        #countdown { font-size: 6em; font-weight: bold; color: var(--neon-pink); text-shadow: 0 0 10px var(--neon-pink); position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; animation: pulse-countdown 1s infinite; }
        @keyframes pulse-countdown { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; } }
        .audio-controls { position: fixed; top: 10px; right: 10px; z-index: 10; }
        .audio-controls audio { width: 200px; background: var(--dark-grey); border-radius: 5px; }
        .hero-image { max-width: 40%; height: auto; margin-left: 20px; }
        @media (max-width: 768px) {
            .container { width: 95%; padding: 15px; flex-direction: column; }
            #main-menu { flex-direction: column; align-items: center; }
            .main-menu-content { width: 100%; order: 2; margin-top: 20px; }
            .main-menu-content h1, .main-menu-content p, .main-menu-content #username-display { width: 100%; }
            .main-menu-content button { width: 100%; }
            .hero-image { max-width: 80%; margin: 0 auto; order: 1; }
            h1 { font-size: 1.8em; }
            h2 { font-size: 1.5em; }
            button { padding: 10px 20px; font-size: 1em; }
            #classic-prompt { font-size: 2em; }
            #classic-input-field { font-size: 1.5em; }
            .audio-controls audio { width: 150px; }
        }
    </style>
</head>
<body>
    <div class="squid-carousel-bg" id="menu-background">
        <svg viewBox="0 0 1000 1000">
            <g>
                <circle cx="200" cy="200" r="50" fill="none" stroke="var(--neon-pink)" stroke-width="10" opacity="0.3"/>
                <polygon points="500,150 600,350 400,350" fill="none" stroke="var(--squid-green)" stroke-width="10" opacity="0.3"/>
                <rect x="700" y="100" width="100" height="100" fill="none" stroke="var(--neon-blue)" stroke-width="10" opacity="0.3"/>
                <circle cx="300" cy="700" r="70" fill="none" stroke="var(--neon-pink)" stroke-width="8" opacity="0.2"/>
                <polygon points="100,600 200,800 0,800" fill="none" stroke="var(--squid-green)" stroke-width="8" opacity="0.2"/>
                <rect x="600" y="600" width="120" height="120" fill="none" stroke="var(--neon-blue)" stroke-width="8" opacity="0.2"/>
            </g>
        </svg>
    </div>

    <div class="audio-controls">
        <audio id="background-music" loop>
            <source src="" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
    </div>

    <div id="main-menu" class="container screen">
        <div class="main-menu-content">
            <h1>SQUID QTE</h1>
            <p class="tagline">Survive the games. Test your reflexes.</p>
            <div id="username-display">
                <p class="user-rank"><span id="user-rank-display">Contestant 001</span></p>
                <p>Welcome, <span id="current-username"></span></p>
                <button id="change-user-btn"><i class="fas fa-user-edit"></i> Change Player</button>
            </div>
            <button id="play-btn"><i class="fas fa-gamepad"></i> Play</button>
            <button id="achievements-btn"><i class="fas fa-trophy"></i> Achievements</button>
            <button id="leaderboard-btn"><i class="fas fa-chart-bar"></i> Leaderboard</button>
            <button id="settings-btn"><span class="icon-front-man"></span> Settings</button>
        </div>
        <img src="https://pngimg.com/d/squid_game_PNG67.png" alt="Squid Game Splash Screen" class="hero-image">
    </div>

    <div class="challenge-box" id="challenge-box">
        <h3>Daily Challenge</h3>
        <p id="daily-challenge-text"></p>
        <p id="challenge-status"></p>
        <button id="accept-challenge-btn"><i class="fas fa-check"></i> Start Classic Game</button>
    </div>

    <div id="game-modes-screen" class="container screen" style="display: none;">
        <h2>Select Game Mode</h2>
        <button id="classic-btn"><i class="fas fa-keyboard"></i> Classic Game</button>
        <button id="circle-btn"><span class="icon-circle-soldier"></span> Circle Game</button>
        <button id="marathon-btn"><i class="fas fa-running"></i> Marathon Mode</button>
        <button id="memory-btn"><i class="fas fa-brain"></i> Memory Mode</button>
        <button id="sound-btn"><i class="fas fa-volume-up"></i> Sound Mode</button>
        <button id="game-modes-back-btn"><i class="fas fa-arrow-left"></i> Back to Menu</button>
    </div>

    <div id="classic-mode" class="game-screen screen" style="display: none;">
        <h2>Classic Game</h2>
        <div id="classic-stats" class="game-stats">
            <div class="stat-item"><p>Score</p><span id="classic-score" class="score-stat">0</span></div>
            <div class="stat-item"><p>Streak</p><span id="classic-streak" class="streak-stat">0</span></div>
            <div class="stat-item"><p>Accuracy</p><span id="classic-accuracy" class="accuracy-stat">100%</span></div>
        </div>
        <h1 id="classic-prompt" class="game-prompt">Press Enter to Start</h1>
        <input type="text" id="classic-input-field" class="game-input-field" placeholder="Type here" autocomplete="off" disabled>
        <button id="classic-back-btn"><i class="fas fa-arrow-left"></i> Back to Menu</button>
    </div>

    <div id="circle-mode" class="game-screen screen" style="display: none;">
        <h2>Circle Game</h2>
        <div id="circle-stats" class="game-stats">
            <div class="stat-item"><p>Score</p><span id="circle-score" class="score-stat">0</span></div>
            <div class="stat-item"><p>Streak</p><span id="circle-streak" class="streak-stat">0</span></div>
            <div class="stat-item"><p>Accuracy</p><span id="circle-accuracy" class="accuracy-stat">100%</span></div>
        </div>
        <div id="circle-game-area"></div>
        <button id="circle-back-btn"><i class="fas fa-arrow-left"></i> Back to Menu</button>
    </div>
    
    <div id="marathon-mode" class="game-screen screen" style="display: none;">
        <h2>Marathon Mode</h2>
        <div id="marathon-stats" class="game-stats">
            <div class="stat-item"><p>Score</p><span id="marathon-score" class="score-stat">0</span></div>
            <div class="stat-item"><p>Time</p><span id="marathon-time" class="streak-stat">0s</span></div>
            <div class="stat-item"><p>Difficulty</p><span id="marathon-difficulty" class="accuracy-stat">100%</span></div>
        </div>
        <h1 id="marathon-prompt" class="game-prompt">Press Enter to Start</h1>
        <input type="text" id="marathon-input-field" class="game-input-field" placeholder="Type here" autocomplete="off" disabled>
        <button id="marathon-back-btn"><i class="fas fa-arrow-left"></i> Back to Menu</button>
    </div>

    <div id="memory-mode" class="game-screen screen" style="display: none;">
        <h2>Memory Mode</h2>
        <div id="memory-stats" class="game-stats">
            <div class="stat-item"><p>Score</p><span id="memory-score" class="score-stat">0</span></div>
            <div class="stat-item"><p>Round</p><span id="memory-round" class="streak-stat">0</span></div>
            <div class="stat-item"><p>Mistakes</p><span id="memory-mistakes" class="accuracy-stat">0</span></div>
        </div>
        <h1 id="memory-prompt" class="game-prompt">Press Enter to Start</h1>
        <input type="text" id="memory-input-field" class="game-input-field" placeholder="Type key sequence" autocomplete="off" disabled>
        <button id="memory-back-btn"><i class="fas fa-arrow-left"></i> Back to Menu</button>
    </div>

    <div id="sound-mode" class="game-screen screen" style="display: none;">
        <h2>Sound Mode</h2>
        <div id="sound-stats" class="game-stats">
            <div class="stat-item"><p>Score</p><span id="sound-score" class="score-stat">0</span></div>
            <div class="stat-item"><p>Streak</p><span id="sound-streak" class="streak-stat">0</span></div>
            <div class="stat-item"><p>Accuracy</p><span id="sound-accuracy" class="accuracy-stat">100%</span></div>
        </div>
        <h1 id="sound-prompt" class="game-prompt">Press Enter to Start</h1>
        <button id="sound-play-btn"><i class="fas fa-play"></i> Play Sound</button>
        <input type="text" id="sound-input-field" class="game-input-field" placeholder="Type key corresponding to sound" autocomplete="off" disabled>
        <button id="sound-back-btn"><i class="fas fa-arrow-left"></i> Back to Menu</button>
    </div>

    <div id="achievements-screen" class="container screen" style="display: none;">
        <h2>Achievements</h2>
        <ul id="achievements-list" class="achievements-list"></ul>
        <button id="achievements-back-btn"><i class="fas fa-arrow-left"></i> Back to Menu</button>
    </div>


    <div id="countdown" style="display: none;"></div>

    <div id="settings-screen" class="container screen" style="display: none;">
        <h2>Settings</h2>
        <div class="settings-group">
            <label for="music-toggle">Background Music</label>
            <div class="toggle-switch">
                <input type="checkbox" id="music-toggle">
                <label for="music-toggle"></label>
            </div>
        </div>
        <div class="settings-group">
            <label for="music-volume">Music Volume:</label>
            <div class="setting-control">
                <input type="range" id="music-volume" min="0" max="100" value="100">
                <span id="volume-display">100%</span>
            </div>
        </div>
        <div class="settings-group">
            <label for="menu-track">Menu Music:</label>
            <select id="menu-track"></select>
        </div>
        <div class="settings-group">
            <label for="classic-track">Classic Game Music:</label>
            <select id="classic-track"></select>
        </div>
        <div class="settings-group">
            <label for="circle-track">Circle Game Music:</label>
            <select id="circle-track"></select>
        </div>
        <div class="settings-group">
            <label for="marathon-track">Marathon Mode Music:</label>
            <select id="marathon-track"></select>
        </div>
        <div class="settings-group">
            <label for="memory-track">Memory Mode Music:</label>
            <select id="memory-track"></select>
        </div>
        <div class="settings-group">
            <label for="sound-track">Sound Mode Music:</label>
            <select id="sound-track"></select>
        </div>
        <div class="settings-group">
            <label for="ui-color">UI Color:</label>
            <div class="player-color-picker">
                <div class="color-box" data-color="red" style="background-color: var(--light-red);"></div>
                <div class="color-box" data-color="pink" style="background-color: var(--neon-pink);"></div>
                <div class="color-box" data-color="green" style="background-color: var(--squid-green);"></div>
                <div class="color-box" data-color="blue" style="background-color: var(--neon-blue);"></div>
            </div>
        </div>
        <div class="settings-group">
            <label for="ink-game-settings-toggle">Ink Game Settings</label>
            <div class="toggle-switch">
                <input type="checkbox" id="ink-game-settings-toggle">
                <label for="ink-game-settings-toggle"></label>
            </div>
        </div>
        <div class="settings-group">
            <label for="difficulty-level">Difficulty (ms):</label>
            <input type="number" id="difficulty-level" min="100" max="2000" step="50" value="500">
        </div>
        <div class="settings-group">
            <label for="spawn-gap">Spawn Gap (ms):</label>
            <input type="number" id="spawn-gap" min="500" max="5000" step="100" value="1500">
        </div>
        <div class="settings-group">
            <label for="custom-keys">Custom Keys (comma-separated):</label>
            <input type="text" id="custom-keys" value="a,s,d,f,j,k,l">
        </div>
        <div style="display: flex; flex-direction: column; width: 100%; margin-top: 20px;">
            <button id="settings-save-btn"><i class="fas fa-save"></i> Save Settings</button>
            <button id="settings-back-btn"><i class="fas fa-arrow-left"></i> Back to Menu</button>
        </div>
    </div>

    <div id="leaderboard-screen" class="container screen" style="display: none;">
        <h2>Leaderboard</h2>
        <table class="leaderboard-table">
            <thead>
                <tr>
                    <th>Player</th>
                    <th>Game</th>
                    <th>Score</th>
                    <th>Streak</th>
                    <th>Accuracy</th>
                    <th>Reaction Time</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody id="leaderboard-body">
                </tbody>
        </table>
        <div style="margin-top: 20px;">
            <button id="export-btn"><i class="fas fa-file-export"></i> Export Data</button>
            <button id="import-btn"><i class="fas fa-file-import"></i> Import Data</button>
        </div>
        <button id="leaderboard-back-btn"><i class="fas fa-arrow-left"></i> Back to Menu</button>
    </div>

    <div id="username-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-username-modal">&times;</span>
            <h3>Select or Create Player</h3>
            <p>Type an existing player name or create a new one.</p>
            <input type="text" id="username-input" placeholder="Enter player name">
            <div id="user-suggestions" style="text-align: left; margin: 10px 0;"></div>
            <button id="select-user-btn"><i class="fas fa-check"></i> Select Player</button>
        </div>
    </div>

    <div id="export-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-export-modal">&times;</span>
            <h3>Export Leaderboard Data</h3>
            <p>Copy the JSON below to save your data.</p>
            <textarea id="export-textarea" rows="10" readonly style="width: 100%; border-radius: 8px; background-color: #1a1a1a; color: white; border: 1px solid var(--squid-green);"></textarea>
            <button onclick="copyToClipboard('export-textarea')"><i class="fas fa-copy"></i> Copy to Clipboard</button>
        </div>
    </div>

    <div id="import-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-import-modal">&times;</span>
            <h3>Import Leaderboard Data</h3>
            <p>Paste your JSON data below and click Import.</p>
            <textarea id="import-textarea" rows="10" style="width: 100%; border-radius: 8px; background-color: #1a1a1a; color: white; border: 1px solid var(--squid-green);"></textarea>
            <button id="import-data-btn"><i class="fas fa-upload"></i> Import Data</button>
        </div>
    </div>

    <div id="game-over-modal" class="modal">
        <div class="modal-content">
            <h3>Game Over!</h3>
            <p id="game-over-message"></p>
            <div class="button-group">
                <button id="restart-game-btn"><i class="fas fa-redo"></i> Play Again</button>
                <button id="return-menu-btn"><i class="fas fa-arrow-left"></i> Back to Menu</button>
            </div>
        </div>
    </div>

    <div class="footer">
        <p><span class="author">Made By Arjun E</span> | &copy; 2024 Squid QTE Trainer. Inspired by the Netflix series 'Squid Game'.</p>
    </div>

    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                    row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                    headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded');

            const screens = document.querySelectorAll('.screen');
            const countdownElement = document.getElementById('countdown');
            const backgroundMusic = document.getElementById('background-music');

            const tracks = [
                { name: 'Squid Game Choir', src: 'audio/macabre-choir-inspired-by-squid-game-287425.mp3' },
                { name: 'Piano Classical', src: 'audio/piano-classical-music-347514.mp3' },
                { name: 'Sad Ballerina Waltz', src: 'audio/sad-ballerina-waltz-113207.mp3' },
                { name: 'Click Sound', src: 'audio/click-sound-effect-150275.mp3' },
                { name: 'Miss Sound', src: 'audio/miss-sound-effect-150276.mp3' },
                { name: 'Achievement Sound', src: 'audio/achievement-sound-effect-150277.mp3' }
            ];

            const soundEffects = {
                click: new Audio(tracks[3].src),
                miss: new Audio(tracks[4].src),
                achievement: new Audio(tracks[5].src)
            };

            let users = {};
            try {
                users = JSON.parse(localStorage.getItem('qte_users')) || {};
            } catch (e) {
                console.error('Error parsing qte_users from localStorage:', e);
            }

            const defaultSettings = {
                musicOn: true,
                difficulty: 500,
                spawnGap: 1500,
                customKeys: 'a,s,d,f,j,k,l',
                volume: 1,
                menuTrack: 0,
                classicTrack: 1,
                circleTrack: 2,
                marathonTrack: 0,
                memoryTrack: 2,
                soundTrack: 1,
                uiColor: 'pink'
            };
            let settings = defaultSettings;
            try {
                const storedSettings = localStorage.getItem('qte_settings');
                if (storedSettings) {
                    settings = { ...defaultSettings, ...JSON.parse(storedSettings) };
                }
            } catch (e) {
                console.error('Error parsing qte_settings from localStorage:', e);
            }
            
            const colorMap = {
                red: '#e50914',
                pink: '#ff5c8d',
                green: '#2f847c',
                blue: '#00d4ff'
            };

            let currentUser = 'Player1';
            let currentGameMode = '';
            let classicGameActive = false;
            let circleGameActive = false;
            let marathonGameActive = false;
            let memoryGameActive = false;
            let soundGameActive = false;
            let classicStats = { score: 0, streak: 0, hits: 0, misses: 0, totalReactionTime: 0 };
            let circleStats = { score: 0, streak: 0, hits: 0, misses: 0, totalReactionTime: 0, wrongInputs: 0 };
            let marathonStats = { score: 0, time: 0, hits: 0, misses: 0, totalReactionTime: 0 };
            let memoryStats = { score: 0, round: 0, mistakes: 0, inputHistory: [] };
            let soundStats = { score: 0, streak: 0, hits: 0, misses: 0, totalReactionTime: 0 };

            let leaderboard = [];
            try {
                leaderboard = JSON.parse(localStorage.getItem('qte_leaderboard')) || [];
            } catch (e) {
                console.error('Error parsing qte_leaderboard from localStorage:', e);
            }
            
            const ranks = {
                0: 'Contestant 001',
                5000: 'Contestant 100',
                10000: 'Junior Guard',
                20000: 'Senior Guard',
                50000: 'VIP',
                100000: 'Front Man'
            };

            const achievements = [
                { id: 'first_game', name: 'First Blood', description: 'Complete your first game.', unlocked: false },
                { id: '10_streak', name: 'Hot Streak', description: 'Achieve a 10-hit streak.', unlocked: false },
                { id: '500_score', name: 'Point Collector', description: 'Score 500 points in one game.', unlocked: false },
                { id: 'speedy', name: 'Speed Demon', description: 'Finish a Classic QTE with < 100ms average reaction time.', unlocked: false }
            ];

            const dailyChallengeData = {
                id: null,
                date: null,
                completed: false,
                challengeText: ''
            };
            
            let hasUserInteracted = false;
            let currentTrackIndex = -1;
            let marathonTimer = null;
            let marathonInterval = null;
            let marathonDifficulty = 500;
            let memorySequence = [];
            let memoryInput = [];
            let memoryTimeout = null;
            let soundTimeout = null;
            let classicTimeout = null;
            let currentClassicPrompt = '';
            let classicStartTime = 0;
            let maxStreak = 0;
            let finalReactionTime = 'N/A';
            let activeCircleTarget = null;
            let circleTimeoutTimer = null;
            let currentMarathonPrompt = '';
            let marathonStartTime = 0;

            const classicPromptElement = document.getElementById('classic-prompt');
            const classicInputField = document.getElementById('classic-input-field');
            const circleGameArea = document.getElementById('circle-game-area');

            const tryPlayAudio = () => {
                const musicToggle = document.getElementById('music-toggle');
                if (musicToggle && musicToggle.checked && !hasUserInteracted) {
                    backgroundMusic.volume = settings.volume;
                    backgroundMusic.src = tracks[settings.menuTrack].src;
                    backgroundMusic.play().catch(e => console.error("Initial autoplay prevented:", e));
                    currentTrackIndex = settings.menuTrack;
                    hasUserInteracted = true;
                }
            };
            
            document.body.addEventListener('click', () => {
                if (!hasUserInteracted) {
                    tryPlayAudio();
                }
            }, { once: true });


            const getRandomKey = () => {
                const keys = settings.customKeys.split(',').filter(k => k.length === 1);
                if (keys.length === 0) {
                    console.warn('No valid custom keys, using default: a');
                    return 'a';
                }
                return keys[Math.floor(Math.random() * keys.length)];
            };
            
            const updateMusicSources = () => {
                const musicSelects = ['menu-track', 'classic-track', 'circle-track', 'marathon-track', 'memory-track', 'sound-track'];
                musicSelects.forEach(id => {
                    const select = document.getElementById(id);
                    if (select) {
                        select.innerHTML = '';
                        tracks.forEach((track, index) => {
                            select.appendChild(new Option(track.name, index));
                        });
                        select.value = settings[id.replace('-', '')];
                    }
                });

                const volumeInput = document.getElementById('music-volume');
                const volumeDisplay = document.getElementById('volume-display');
                if (volumeInput && volumeDisplay) {
                    volumeInput.value = settings.volume * 100;
                    volumeDisplay.textContent = `${volumeInput.value}%`;
                    volumeInput.addEventListener('input', () => {
                        volumeDisplay.textContent = `${volumeInput.value}%`;
                        settings.volume = volumeInput.value / 100;
                        backgroundMusic.volume = settings.volume;
                        for (const effect in soundEffects) {
                            soundEffects[effect].volume = settings.volume;
                        }
                    });
                }
            };

            const switchTrack = (trackIndex) => {
                if (!settings.musicOn || trackIndex === currentTrackIndex) {
                    if (!settings.musicOn) {
                        backgroundMusic.pause();
                    }
                    return;
                }
                const newSrc = tracks[trackIndex]?.src;
                if (newSrc) {
                    try {
                        console.log('Changing audio track to:', newSrc);
                        backgroundMusic.pause();
                        backgroundMusic.src = newSrc;
                        backgroundMusic.load();
                        backgroundMusic.play().catch(e => console.error('Playback error:', e));
                        currentTrackIndex = trackIndex;
                    } catch (e) {
                        console.error('Error changing audio track:', e);
                    }
                } else {
                    backgroundMusic.pause();
                }
            };

            const showScreen = (screenId) => {
                screens.forEach(screen => { screen.style.display = 'none'; });
                const targetScreen = document.getElementById(screenId);
                targetScreen.style.display = targetScreen.classList.contains('container') ? 'flex' : 'block';
                document.getElementById('menu-background').style.display = (screenId === 'main-menu') ? 'block' : 'none';

                let trackIndex;
                switch(screenId) {
                    case 'main-menu':
                    case 'settings-screen':
                    case 'leaderboard-screen':
                    case 'achievements-screen':
                    case 'game-modes-screen':
                    trackIndex = settings.menuTrack;
                    break;
                    case 'classic-mode':
                    trackIndex = settings.classicTrack;
                    break;
                    case 'circle-mode':
                    trackIndex = settings.circleTrack;
                    break;
                    case 'marathon-mode':
                    trackIndex = settings.marathonTrack;
                    break;
                    case 'memory-mode':
                    trackIndex = settings.memoryTrack;
                    break;
                    case 'sound-mode':
                    trackIndex = settings.soundTrack;
                    break;
                }
                
                if (settings.musicOn) {
                    switchTrack(trackIndex);
                } else {
                    backgroundMusic.pause();
                }

                if (screenId === 'settings-screen') {
                    loadSettings();
                }
            };
            
            const loadSettings = () => {
                document.getElementById('music-toggle').checked = settings.musicOn;
                document.getElementById('music-volume').value = settings.volume * 100;
                document.getElementById('volume-display').textContent = `${settings.volume * 100}%`;
                document.getElementById('menu-track').value = settings.menuTrack;
                document.getElementById('classic-track').value = settings.classicTrack;
                document.getElementById('circle-track').value = settings.circleTrack;
                document.getElementById('marathon-track').value = settings.marathonTrack;
                document.getElementById('memory-track').value = settings.memoryTrack;
                document.getElementById('sound-track').value = settings.soundTrack;
                document.getElementById('difficulty-level').value = settings.difficulty;
                document.getElementById('spawn-gap').value = settings.spawnGap;
                document.getElementById('custom-keys').value = settings.customKeys;
                
                document.querySelectorAll('.player-color-picker .color-box').forEach(b => {
                    b.classList.remove('selected');
                    if (b.dataset.color === settings.uiColor) {
                        b.classList.add('selected');
                    }
                });
                document.documentElement.style.setProperty('--neon-pink', colorMap[settings.uiColor]);
                document.documentElement.style.setProperty('--light-red', colorMap[settings.uiColor]);
            };

            const updateDisplayUsername = () => {
                const usernameDisplay = document.getElementById('current-username');
                if (usernameDisplay) usernameDisplay.textContent = currentUser;
                const userRankDisplay = document.getElementById('user-rank-display');
                if (userRankDisplay) userRankDisplay.textContent = getUserRank();
                updateChallengeStatus();
            };

            const saveUsers = () => {
                localStorage.setItem('qte_users', JSON.stringify(users));
            };

            const saveSettings = () => {
                localStorage.setItem('qte_settings', JSON.stringify(settings));
            };

            const updateStatsDisplay = (mode) => {
                let stats = {};
                let prefix = '';
                switch(mode) {
                    case 'classic': stats = classicStats; prefix = 'classic'; break;
                    case 'circle': stats = circleStats; prefix = 'circle'; break;
                    case 'marathon': stats = marathonStats; prefix = 'marathon'; break;
                    case 'memory': stats = memoryStats; prefix = 'memory'; break;
                    case 'sound': stats = soundStats; prefix = 'sound'; break;
                }
                
                const statsElement = document.getElementById(`${prefix}-stats`);
                if (statsElement) {
                    if (stats.score !== undefined) statsElement.querySelector('.score-stat').textContent = stats.score;
                    if (stats.streak !== undefined) statsElement.querySelector('.streak-stat').textContent = stats.streak;
                    if (stats.hits !== undefined && stats.misses !== undefined) {
                        const totalAttempts = stats.hits + stats.misses + (stats.wrongInputs || 0);
                        const accuracy = totalAttempts > 0 ? Math.round((stats.hits / totalAttempts) * 100) : 100;
                        if (statsElement.querySelector('.accuracy-stat')) statsElement.querySelector('.accuracy-stat').textContent = `${accuracy}%`;
                    }
                    if (stats.time !== undefined) statsElement.querySelector('.streak-stat').textContent = `${Math.floor(stats.time)}s`;
                    if (stats.round !== undefined) statsElement.querySelector('.streak-stat').textContent = stats.round;
                    if (stats.mistakes !== undefined) statsElement.querySelector('.accuracy-stat').textContent = stats.mistakes;

                    if (stats.streak && stats.streak >= 10) {
                        statsElement.classList.add('high-streak-glow');
                    } else {
                        statsElement.classList.remove('high-streak-glow');
                    }
                }
            };

            const startCountdown = (callback) => {
                maxStreak = 0;
                let count = 3;
                countdownElement.textContent = count;
                countdownElement.style.display = 'block';
                const countdownInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        countdownElement.textContent = count;
                    } else {
                        clearInterval(countdownInterval);
                        countdownElement.style.display = 'none';
                        callback();
                    }
                }, 1000);
            };

            const showGameOver = (message, mode, stats) => {
                const finalStats = {
                    score: stats.score,
                    streak: stats.streak || 'N/A',
                    accuracy: stats.hits !== undefined ?
                        (stats.hits + stats.misses + (stats.wrongInputs || 0) > 0 ? Math.round((stats.hits / (stats.hits + stats.misses + (stats.wrongInputs || 0))) * 100) : 100) :
                        'N/A',
                    reactionTime: stats.hits > 0 ? (stats.totalReactionTime / stats.hits).toFixed(2) : 'N/A',
                    time: stats.time !== undefined ? stats.time : 'N/A',
                    round: stats.round !== undefined ? stats.round : 'N/A'
                };
                
                if (!users[currentUser]) users[currentUser] = { classic: {}, circle: {}, marathon: {}, memory: {}, sound: {}, totalScore: 0, achievements: {} };
                const userModeStats = users[currentUser][mode];
                if (!userModeStats || finalStats.score > userModeStats.score) {
                    users[currentUser][mode] = finalStats;
                }
                
                users[currentUser].totalScore = (users[currentUser].totalScore || 0) + finalStats.score;
                
                checkAchievements(stats);

                const newEntry = {
                    user: currentUser,
                    mode: mode,
                    score: finalStats.score,
                    streak: finalStats.streak,
                    accuracy: finalStats.accuracy,
                    reactionTime: finalStats.reactionTime,
                    timestamp: new Date().toLocaleString()
                };
                
                let currentLeaderboard = JSON.parse(localStorage.getItem('qte_leaderboard')) || [];
                currentLeaderboard.push(newEntry);
                currentLeaderboard.sort((a, b) => b.score - a.score);
                localStorage.setItem('qte_leaderboard', JSON.stringify(currentLeaderboard.slice(0, 5)));

                let messageHtml = `${message}<br><br>Final Score: ${finalStats.score}<br>`;
                if (finalStats.streak !== 'N/A') messageHtml += `Max Streak: ${maxStreak}<br>`;
                if (finalStats.accuracy !== 'N/A') messageHtml += `Accuracy: ${finalStats.accuracy}%<br>`;
                if (finalStats.reactionTime !== 'N/A') messageHtml += `Avg. Reaction Time: ${finalStats.reactionTime}ms<br>`;
                if (finalStats.time !== 'N/A') messageHtml += `Time Survived: ${finalStats.time}s<br>`;
                if (finalStats.round !== 'N/A') messageHtml += `Rounds Completed: ${finalStats.round}<br>`;

                document.getElementById('game-over-message').innerHTML = messageHtml;
                document.getElementById('game-over-modal').style.display = 'flex';
            };
            
            const resetGame = (mode) => {
                let stats = {};
                switch(mode) {
                    case 'classic': classicGameActive = false; clearTimeout(classicTimeout); stats = classicStats; break;
                    case 'circle': circleGameActive = false; clearTimeout(circleTimeoutTimer); if (activeCircleTarget) activeCircleTarget.remove(); activeCircleTarget = null; stats = circleStats; break;
                    case 'marathon': clearInterval(marathonInterval); clearTimeout(marathonTimeout); marathonGameActive = false; stats = marathonStats; break;
                    case 'memory': clearTimeout(memoryTimeout); memoryGameActive = false; stats = memoryStats; break;
                    case 'sound': clearTimeout(soundTimeout); soundGameActive = false; stats = soundStats; break;
                }
                
                Object.keys(stats).forEach(key => stats[key] = 0);
                if (mode === 'circle') document.getElementById('circle-game-area').innerHTML = '';
                if (mode === 'marathon') marathonDifficulty = 500;
                
                updateStatsDisplay(mode);
                document.getElementById('game-over-modal').style.display = 'none';
            };

            const startClassicGame = () => {
                resetGame('classic'); // Reset stats before starting
                startCountdown(() => {
                    currentGameMode = 'classic';
                    classicGameActive = true;
                    classicStats = { score: 0, streak: 0, hits: 0, misses: 0, totalReactionTime: 0 };
                    updateStatsDisplay('classic');
                    classicInputField.value = '';
                    classicInputField.disabled = false;
                    classicInputField.focus();
                    if (classicPromptElement) {
                        classicPromptElement.textContent = '...';
                        classicPromptElement.style.animation = 'none';
                    }
                    generateClassicPrompt();
                });
            };

            const generateClassicPrompt = () => {
                if (!classicGameActive) return;
                const keys = settings.customKeys.split(',').filter(k => k.length === 1);
                if (keys.length === 0) { console.warn('No custom keys defined, cannot generate prompt.'); showGameOver('No custom keys defined in settings!', 'classic', classicStats); return; }
                currentClassicPrompt = getRandomKey();
                if (classicPromptElement) classicPromptElement.textContent = `Type: ${currentClassicPrompt.toUpperCase()}`;
                classicStartTime = performance.now();
                clearTimeout(classicTimeout);
                classicTimeout = setTimeout(() => {
                    classicStats.misses++;
                    classicStats.streak = 0;
                    showGameOver(`You missed the prompt!`, 'classic', classicStats);
                }, settings.difficulty);
            };

            const handleClassicInput = (event) => {
                if (!classicGameActive || !classicInputField || document.activeElement !== classicInputField) return;
                const inputChar = event.key.toLowerCase();
                if (inputChar === currentClassicPrompt) {
                    const reactionTime = performance.now() - classicStartTime;
                    classicStats.hits++;
                    classicStats.totalReactionTime += reactionTime;
                    classicStats.score += 100;
                    classicStats.streak++;
                    if (classicStats.streak > maxStreak) {
                        maxStreak = classicStats.streak;
                    }
                    updateStatsDisplay('classic');
                    generateClassicPrompt();
                } else {
                    classicStats.misses++;
                    classicStats.streak = 0;
                    showGameOver(`Wrong key! You typed '${inputChar}' instead of '${currentClassicPrompt}'.`, 'classic', classicStats);
                }
                classicInputField.value = '';
            };

            const startCircleGame = () => {
                resetGame('circle'); // Reset stats before starting
                startCountdown(() => {
                    currentGameMode = 'circle';
                    circleGameActive = true;
                    circleStats = { score: 0, streak: 0, hits: 0, misses: 0, totalReactionTime: 0, wrongInputs: 0 };
                    updateStatsDisplay('circle');
                    spawnCircleTarget();
                });
            };
            
            const spawnCircleTarget = () => {
                if (!circleGameActive) return;
                if (activeCircleTarget) return;
                try {
                    const targetKey = getRandomKey();
                    const targetSize = 150;
                    if (!circleGameArea) return; // Add null check for the game area
                    const areaWidth = circleGameArea.clientWidth;
                    const areaHeight = circleGameArea.clientHeight;
                    const x = Math.random() * (areaWidth - targetSize) + targetSize / 2;
                    const y = Math.random() * (areaHeight - targetSize) + targetSize / 2;
                    const targetDiv = document.createElement('div');
                    targetDiv.className = 'circle-target';
                    targetDiv.dataset.key = targetKey;
                    targetDiv.dataset.startTime = performance.now();
                    targetDiv.style.left = `${x}px`;
                    targetDiv.style.top = `${y}px`;
                    const outer = document.createElement('div');
                    outer.className = 'outer-circle';
                    outer.style.borderColor = colorMap[settings.uiColor] || 'var(--neon-pink)';
                    const inner = document.createElement('div');
                    inner.className = 'inner-circle';
                    const button = document.createElement('div');
                    button.className = 'key-button';
                    button.textContent = targetKey.toUpperCase();
                    targetDiv.appendChild(outer);
                    targetDiv.appendChild(inner);
                    targetDiv.appendChild(button);
                    circleGameArea.appendChild(targetDiv);
                    activeCircleTarget = targetDiv;
                    const duration = settings.difficulty;
                    outer.style.transition = `transform ${duration}ms linear, border-color ${duration}ms linear`;
                    setTimeout(() => {
                        outer.style.transform = 'scale(0.5)';
                        outer.style.borderColor = 'var(--dark-red)';
                    }, 10);
                    clearTimeout(circleTimeoutTimer);
                    circleTimeoutTimer = setTimeout(() => {
                        if (activeCircleTarget === targetDiv) {
                            circleStats.misses++;
                            circleStats.streak = 0;
                            showGameOver('You missed a circle!', 'circle', circleStats);
                        }
                    }, settings.difficulty + 50);
                } catch (e) {
                    console.error('Error in spawnCircleTarget:', e);
                }
            };

            const handleCircleInput = (event) => {
                if (!circleGameActive || !activeCircleTarget) return;
                const inputChar = event.key.toLowerCase();
                const targetKey = activeCircleTarget.dataset.key;
                if (inputChar === targetKey) {
                    const reactionTime = performance.now() - parseFloat(activeCircleTarget.dataset.startTime);
                    const outer = activeCircleTarget.querySelector('.outer-circle');
                    const inner = activeCircleTarget.querySelector('.inner-circle');
                    const outerRect = outer.getBoundingClientRect();
                    const innerRect = inner.getBoundingClientRect();
                    let points = outerRect.width <= innerRect.width + 10 ? 200 : 100;
                    if (points === 200) {
                        inner.style.backgroundColor = 'rgba(0, 255, 0, 0.5)';
                        inner.style.borderColor = 'var(--neon-green)';
                    }
                    const hitEffect = document.createElement('div');
                    hitEffect.className = 'hit-effect';
                    const effectSize = inner.offsetWidth * 2;
                    hitEffect.style.width = `${effectSize}px`;
                    hitEffect.style.height = `${effectSize}px`;
                    hitEffect.style.left = `${activeCircleTarget.offsetLeft - (effectSize / 2 - activeCircleTarget.offsetWidth / 2)}px`;
                    hitEffect.style.top = `${activeCircleTarget.offsetTop - (effectSize / 2 - activeCircleTarget.offsetHeight / 2)}px`;
                    circleGameArea.appendChild(hitEffect);
                    hitEffect.addEventListener('animationend', () => hitEffect.remove());
                    circleStats.hits++;
                    circleStats.totalReactionTime += reactionTime;
                    circleStats.score += points;
                    circleStats.streak++;
                    if (circleStats.streak > maxStreak) {
                        maxStreak = circleStats.streak;
                    }
                    updateStatsDisplay('circle');
                    activeCircleTarget.remove();
                    activeCircleTarget = null;
                    setTimeout(spawnCircleTarget, settings.spawnGap);
                } else {
                    circleStats.wrongInputs++;
                    circleStats.streak = 0;
                    showGameOver(`Wrong key! You typed '${inputChar}'`, 'circle', circleStats);
                }
            };

            const startMarathonGame = () => {
                resetGame('marathon');
                startCountdown(() => {
                    currentGameMode = 'marathon';
                    marathonGameActive = true;
                    marathonStats = { score: 0, time: 0, hits: 0, misses: 0, totalReactionTime: 0 };
                    marathonDifficulty = 500;
                    const marathonPromptElement = document.getElementById('marathon-prompt');
                    if (marathonPromptElement) marathonPromptElement.style.animation = 'none';
                    const marathonInputField = document.getElementById('marathon-input-field');
                    if (marathonInputField) {
                        marathonInputField.disabled = false;
                        marathonInputField.focus();
                    }
                    marathonInterval = setInterval(() => {
                        marathonStats.time++;
                        marathonStats.score += 10;
                        marathonDifficulty = Math.max(100, 500 - Math.floor(marathonStats.time / 10) * 20);
                        updateStatsDisplay('marathon');
                    }, 1000);
                    generateMarathonPrompt();
                });
            };

            const generateMarathonPrompt = () => {
                if (!marathonGameActive) return;
                const keys = settings.customKeys.split(',').filter(k => k.length === 1);
                if (keys.length === 0) { console.warn('No custom keys defined, cannot generate prompt.'); showGameOver('No custom keys defined!', 'marathon', marathonStats); return; }
                const promptElement = document.getElementById('marathon-prompt');
                const inputField = document.getElementById('marathon-input-field');
                if (!promptElement || !inputField) return;
                inputField.value = '';
                inputField.disabled = false;
                inputField.focus();
                
                currentMarathonPrompt = getRandomKey();
                promptElement.textContent = `Type: ${currentMarathonPrompt.toUpperCase()}`;
                marathonStartTime = performance.now();
                clearTimeout(marathonTimeout);
                marathonTimeout = setTimeout(() => {
                    marathonStats.misses++;
                    showGameOver('Time ran out!', 'marathon', marathonStats);
                }, marathonDifficulty);
            };

            const handleMarathonInput = (event) => {
                const marathonInputField = document.getElementById('marathon-input-field');
                if (!marathonGameActive || !marathonInputField || document.activeElement !== marathonInputField) return;
                const promptElement = document.getElementById('marathon-prompt');
                const inputChar = event.key.toLowerCase();
                const currentPrompt = promptElement.textContent.trim().toLowerCase().replace('type: ', '');
                
                if (inputChar === currentPrompt) {
                    const reactionTime = performance.now() - marathonStartTime;
                    marathonStats.hits++;
                    marathonStats.totalReactionTime += reactionTime;
                    marathonStats.score += 100;
                    updateStatsDisplay('marathon');
                    clearTimeout(marathonTimeout);
                    generateMarathonPrompt();
                } else {
                    marathonStats.misses++;
                    showGameOver(`Wrong key! You typed '${inputChar}' instead of '${currentPrompt}'.`, 'marathon', marathonStats);
                }
                marathonInputField.value = '';
            };

            const startMemoryGame = () => {
                resetGame('memory');
                startCountdown(() => {
                    currentGameMode = 'memory';
                    memoryGameActive = true;
                    memoryStats = { score: 0, round: 1, mistakes: 0, inputHistory: [] };
                    const memoryPromptElement = document.getElementById('memory-prompt');
                    if (memoryPromptElement) memoryPromptElement.style.animation = 'none';
                    updateStatsDisplay('memory');
                    generateMemorySequence();
                });
            };
            
            const generateMemorySequence = () => {
                if (!memoryGameActive) return;
                const promptElement = document.getElementById('memory-prompt');
                const inputField = document.getElementById('memory-input-field');
                if (!promptElement || !inputField) return;
                inputField.disabled = true;
                memoryInput = [];
                const sequenceLength = memoryStats.round;
                const keys = settings.customKeys.split(',').filter(k => k.length === 1);
                memorySequence = Array.from({length: sequenceLength}, () => keys[Math.floor(Math.random() * keys.length)]);
                
                let i = 0;
                const displayInterval = setInterval(() => {
                    if (i < memorySequence.length) {
                        promptElement.textContent = memorySequence[i].toUpperCase();
                        i++;
                    } else {
                        clearInterval(displayInterval);
                        setTimeout(() => {
                            promptElement.textContent = '...';
                            inputField.disabled = false;
                            inputField.focus();
                        }, 1000);
                    }
                }, 750);
            };

            const handleMemoryInput = (event) => {
                const memoryInputField = document.getElementById('memory-input-field');
                if (!memoryGameActive || !memoryInputField || document.activeElement !== memoryInputField || event.key !== 'Enter') return;
                const input = memoryInputField.value.toLowerCase().split('');
                if (input.join('') === memorySequence.join('')) {
                    memoryStats.score += memoryStats.round * 100;
                    memoryStats.round++;
                    updateStatsDisplay('memory');
                    generateMemorySequence();
                } else {
                    memoryStats.mistakes++;
                    if (memoryStats.mistakes >= 3) {
                        showGameOver('Too many mistakes!', 'memory', memoryStats);
                    } else {
                        alert('Wrong sequence! Try again.');
                        generateMemorySequence();
                    }
                }
                memoryInputField.value = '';
            };
            
            const startSoundGame = () => {
                resetGame('sound');
                startCountdown(() => {
                    currentGameMode = 'sound';
                    soundGameActive = true;
                    soundStats = { score: 0, streak: 0, hits: 0, misses: 0, totalReactionTime: 0 };
                    updateStatsDisplay('sound');
                    const soundInputField = document.getElementById('sound-input-field');
                    if (soundInputField) {
                        soundInputField.disabled = false;
                        soundInputField.focus();
                    }
                    playSoundCue();
                });
            };
            
            let currentSoundPrompt = '';
            const playSoundCue = () => {
                if (!soundGameActive) return;
                const keys = settings.customKeys.split(',').filter(k => k.length === 1);
                if (keys.length === 0) { console.warn('No custom keys defined.'); showGameOver('No custom keys defined!', 'sound', soundStats); return; }
                currentSoundPrompt = getRandomKey();
                const soundPath = `audio/sound-effect-${currentSoundPrompt}.mp3`;
                const sound = new Audio(soundPath);
                sound.play();
                soundTimeout = setTimeout(() => {
                    soundStats.misses++;
                    soundStats.streak = 0;
                    showGameOver('Time ran out!', 'sound', soundStats);
                }, settings.difficulty);
            };

            const handleSoundInput = (event) => {
                const soundInputField = document.getElementById('sound-input-field');
                if (!soundGameActive || !soundInputField || document.activeElement !== soundInputField) return;
                if (event.key.toLowerCase() === currentSoundPrompt) {
                    clearTimeout(soundTimeout);
                    soundStats.hits++;
                    soundStats.streak++;
                    soundStats.score += 100;
                    updateStatsDisplay('sound');
                    playSoundCue();
                } else {
                    soundStats.misses++;
                    soundStats.streak = 0;
                    showGameOver(`Wrong key! You typed '${event.key.toLowerCase()}'`, 'sound', soundStats);
                }
                soundInputField.value = '';
            };

            const checkAchievements = (stats) => {
                let unlockedAchievement = false;
                if (!users[currentUser]) users[currentUser] = { achievements: {} };
                if (!users[currentUser].achievements) users[currentUser].achievements = {};

                if (stats.hits + stats.misses > 0 && !users[currentUser].achievements.first_game) {
                    users[currentUser].achievements.first_game = true;
                    unlockedAchievement = true;
                }
                if (maxStreak >= 10 && !users[currentUser].achievements['10_streak']) {
                    users[currentUser].achievements['10_streak'] = true;
                    unlockedAchievement = true;
                }
                if (stats.score >= 500 && !users[currentUser].achievements['500_score']) {
                    users[currentUser].achievements['500_score'] = true;
                    unlockedAchievement = true;
                }
                if (stats.totalReactionTime && stats.hits > 0 && (stats.totalReactionTime / stats.hits) < 100 && !users[currentUser].achievements.speedy) {
                    users[currentUser].achievements.speedy = true;
                    unlockedAchievement = true;
                }
                if (unlockedAchievement) soundEffects.achievement.play();
            };
            
            const getUserRank = () => {
                const totalScore = users[currentUser]?.totalScore || 0;
                let rank = 'Contestant 001';
                Object.keys(ranks).forEach(score => {
                    if (totalScore >= parseInt(score)) {
                        rank = ranks[score];
                    }
                });
                return rank;
            };

            const updateChallengeStatus = () => {
                const today = new Date().toISOString().slice(0, 10);
                const challengeBox = document.getElementById('challenge-box');
                const challengeText = document.getElementById('daily-challenge-text');
                const acceptBtn = document.getElementById('accept-challenge-btn');
                const statusText = document.getElementById('challenge-status');
                
                if (dailyChallengeData.date !== today) {
                    dailyChallengeData.id = Math.random().toString(36).substring(7);
                    dailyChallengeData.date = today;
                    dailyChallengeData.completed = false;
                    dailyChallengeData.challengeText = "Get a streak of 10 in Classic Game!";
                    if (challengeText) challengeText.textContent = dailyChallengeData.challengeText;
                    if (acceptBtn) acceptBtn.style.display = 'block';
                    if (statusText) statusText.textContent = '';
                    localStorage.setItem('dailyChallenge', JSON.stringify(dailyChallengeData));
                } else {
                    if (challengeText) challengeText.textContent = dailyChallengeData.challengeText;
                    if (dailyChallengeData.completed) {
                        if (statusText) statusText.textContent = "Completed!";
                        if (acceptBtn) acceptBtn.style.display = 'none';
                    } else {
                        if (statusText) statusText.textContent = "Incomplete";
                        if (acceptBtn) acceptBtn.style.display = 'block';
                    }
                }
            };
            
            document.getElementById('play-btn')?.addEventListener('click', () => { showScreen('game-modes-screen'); });
            document.getElementById('classic-btn')?.addEventListener('click', () => { showScreen('classic-mode'); startClassicGame(); });
            document.getElementById('circle-btn')?.addEventListener('click', () => { showScreen('circle-mode'); startCircleGame(); });
            document.getElementById('marathon-btn')?.addEventListener('click', () => { showScreen('marathon-mode'); startMarathonGame(); });
            document.getElementById('memory-btn')?.addEventListener('click', () => { showScreen('memory-mode'); startMemoryGame(); });
            document.getElementById('sound-btn')?.addEventListener('click', () => { showScreen('sound-mode'); startSoundGame(); });
            document.getElementById('achievements-btn')?.addEventListener('click', () => { showScreen('achievements-screen'); displayAchievements(); });
            document.getElementById('leaderboard-btn')?.addEventListener('click', () => { showLeaderboard(); showScreen('leaderboard-screen'); });
            document.getElementById('settings-btn')?.addEventListener('click', () => { showScreen('settings-screen'); updateMusicSources(); });
            
            document.getElementById('accept-challenge-btn')?.addEventListener('click', () => {
                alert('Challenge accepted! You can start the Classic Game now.');
                showScreen('classic-mode');
                startClassicGame();
            });

            document.getElementById('game-modes-back-btn')?.addEventListener('click', () => { showScreen('main-menu'); });
            document.getElementById('classic-back-btn')?.addEventListener('click', () => { resetGame('classic'); showScreen('game-modes-screen'); });
            document.getElementById('circle-back-btn')?.addEventListener('click', () => { resetGame('circle'); showScreen('game-modes-screen'); });
            document.getElementById('marathon-back-btn')?.addEventListener('click', () => { resetGame('marathon'); showScreen('game-modes-screen'); });
            document.getElementById('memory-back-btn')?.addEventListener('click', () => { resetGame('memory'); showScreen('game-modes-screen'); });
            document.getElementById('sound-back-btn')?.addEventListener('click', () => { resetGame('sound'); showScreen('game-modes-screen'); });
            document.getElementById('achievements-back-btn')?.addEventListener('click', () => { showScreen('main-menu'); });
            document.getElementById('leaderboard-back-btn')?.addEventListener('click', () => { showScreen('main-menu'); });

            document.getElementById('restart-game-btn')?.addEventListener('click', () => {
                const currentMode = currentGameMode;
                resetGame(currentMode);
                switch(currentMode) {
                    case 'classic': startClassicGame(); break;
                    case 'circle': startCircleGame(); break;
                    case 'marathon': startMarathonGame(); break;
                    case 'memory': startMemoryGame(); break;
                    case 'sound': startSoundGame(); break;
                }
            });

            document.getElementById('return-menu-btn')?.addEventListener('click', () => {
                const currentMode = currentGameMode;
                resetGame(currentMode);
                showScreen('main-menu');
            });

            window.addEventListener('keydown', (e) => {
                if (document.getElementById('game-over-modal')?.style.display === 'flex') return;
                switch(currentGameMode) {
                    case 'classic': handleClassicInput(e); break;
                    case 'circle': handleCircleInput(e); break;
                    case 'marathon': handleMarathonInput(e); break;
                    case 'memory': handleMemoryInput(e); break;
                    case 'sound': handleSoundInput(e); break;
                }
            });

            document.getElementById('settings-save-btn')?.addEventListener('click', () => {
                settings.musicOn = document.getElementById('music-toggle')?.checked;
                settings.volume = parseInt(document.getElementById('music-volume')?.value, 10) / 100;
                settings.menuTrack = parseInt(document.getElementById('menu-track')?.value, 10);
                settings.classicTrack = parseInt(document.getElementById('classic-track')?.value, 10);
                settings.circleTrack = parseInt(document.getElementById('circle-track')?.value, 10);
                settings.marathonTrack = parseInt(document.getElementById('marathon-track')?.value, 10);
                settings.memoryTrack = parseInt(document.getElementById('memory-track')?.value, 10);
                settings.soundTrack = parseInt(document.getElementById('sound-track')?.value, 10);
                settings.difficulty = parseInt(document.getElementById('difficulty-level')?.value, 10);
                settings.spawnGap = parseInt(document.getElementById('spawn-gap')?.value, 10);
                settings.customKeys = document.getElementById('custom-keys')?.value.toLowerCase().replace(/[^a-z,]/g, '').split(',').filter(k => k.length === 1).join(',');

                // Save the updated settings object
                saveSettings();

                // Re-apply settings and navigate back
                showScreen('main-menu');
            });

            document.getElementById('settings-back-btn')?.addEventListener('click', () => { showScreen('main-menu'); });

            document.querySelectorAll('.player-color-picker .color-box').forEach(box => {
                box.addEventListener('click', () => {
                    document.querySelectorAll('.player-color-picker .color-box').forEach(b => b.classList.remove('selected'));
                    box.classList.add('selected');
                    settings.uiColor = box.dataset.color;
                    document.documentElement.style.setProperty('--neon-pink', colorMap[settings.uiColor]);
                    document.documentElement.style.setProperty('--light-red', colorMap[settings.uiColor]);
                });
            });

            document.getElementById('ink-game-settings-toggle')?.addEventListener('change', (e) => {
                if (e.target.checked) {
                    const difficultyInput = document.getElementById('difficulty-level');
                    if (difficultyInput) difficultyInput.value = 800;
                    const spawnInput = document.getElementById('spawn-gap');
                    if (spawnInput) spawnInput.value = 1500;
                    const customKeysInput = document.getElementById('custom-keys');
                    if (customKeysInput) customKeysInput.value = 'q,e,f,r';
                }
            });

            document.getElementById('change-user-btn')?.addEventListener('click', () => { 
                const usernameModal = document.getElementById('username-modal');
                if (usernameModal) usernameModal.style.display = 'flex';
                const usernameInput = document.getElementById('username-input');
                if (usernameInput) usernameInput.value = currentUser;
            });
            document.getElementById('close-username-modal')?.addEventListener('click', () => { 
                const usernameModal = document.getElementById('username-modal');
                if (usernameModal) usernameModal.style.display = 'none'; 
            });
            document.getElementById('username-input')?.addEventListener('input', (e) => {
                const input = e.target.value.toLowerCase();
                const suggestionsDiv = document.getElementById('user-suggestions');
                if (!suggestionsDiv) return;
                suggestionsDiv.innerHTML = '';
                const matchingUsers = Object.keys(users).filter(user => user.toLowerCase().startsWith(input) && user.length > 0);
                if (matchingUsers.length > 0 && input.length > 0) {
                    matchingUsers.forEach(user => {
                        const p = document.createElement('p');
                        p.textContent = user;
                        p.style.cursor = 'pointer';
                        p.style.padding = '5px';
                        p.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                        p.style.borderRadius = '5px';
                        p.style.marginBottom = '5px';
                        p.addEventListener('click', () => { 
                            const usernameInput = document.getElementById('username-input');
                            if (usernameInput) usernameInput.value = user; 
                            suggestionsDiv.innerHTML = ''; 
                        });
                        suggestionsDiv.appendChild(p);
                    });
                }
            });
            document.getElementById('select-user-btn')?.addEventListener('click', () => {
                const usernameInput = document.getElementById('username-input');
                if (!usernameInput) return;
                const newUsername = usernameInput.value.trim();
                if (newUsername) {
                    currentUser = newUsername;
                    updateDisplayUsername();
                    const usernameModal = document.getElementById('username-modal');
                    if (usernameModal) usernameModal.style.display = 'none';
                    saveUsers(); // Save the new user
                } else { alert("Please enter a player name."); }
            });

            const showLeaderboard = () => {
                const leaderboardBody = document.getElementById('leaderboard-body');
                if (!leaderboardBody) return;
                leaderboardBody.innerHTML = '';
                let allScores = JSON.parse(localStorage.getItem('qte_leaderboard')) || [];
                allScores.sort((a, b) => b.score - a.score);
                const top5Scores = allScores.slice(0, 5);
                top5Scores.forEach(score => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${score.user}</td><td>${score.mode}</td><td>${score.score}</td><td>${score.streak}</td><td>${score.accuracy}%</td><td>${score.reactionTime}${score.reactionTime !== 'N/A' ? 'ms' : ''}</td><td>${score.timestamp}</td>`;
                    leaderboardBody.appendChild(row);
                });
            };

            const displayAchievements = () => {
                const achievementsList = document.getElementById('achievements-list');
                if (!achievementsList) return;
                achievementsList.innerHTML = '';
                const userAchievements = users[currentUser]?.achievements || {};
                achievements.forEach(ach => {
                    const li = document.createElement('li');
                    li.classList.add('achievement-item');
                    if (userAchievements[ach.id]) {
                        li.classList.add('unlocked');
                    }
                    const iconClass = userAchievements[ach.id] ? 'fas fa-trophy' : 'far fa-trophy';
                    li.innerHTML = `
                        <div class="icon"><i class="${iconClass}"></i></div>
                        <div class="details">
                            <h4>${ach.name}</h4>
                            <p>${ach.description}</p>
                        </div>
                    `;
                    achievementsList.appendChild(li);
                });
            };

            document.getElementById('export-btn')?.addEventListener('click', () => {
                const data = JSON.stringify(users, null, 2);
                const exportTextarea = document.getElementById('export-textarea');
                if (exportTextarea) exportTextarea.value = data;
                const exportModal = document.getElementById('export-modal');
                if (exportModal) exportModal.style.display = 'flex';
            });
            document.getElementById('import-btn')?.addEventListener('click', () => { 
                const importModal = document.getElementById('import-modal');
                if (importModal) importModal.style.display = 'flex'; 
            });
            document.getElementById('close-export-modal')?.addEventListener('click', () => { 
                const exportModal = document.getElementById('export-modal');
                if (exportModal) exportModal.style.display = 'none'; 
            });
            document.getElementById('close-import-modal')?.addEventListener('click', () => { 
                const importModal = document.getElementById('import-modal');
                if (importModal) importModal.style.display = 'none'; 
            });
            document.getElementById('import-data-btn')?.addEventListener('click', () => {
                try {
                    const importTextarea = document.getElementById('import-textarea');
                    if (!importTextarea) return;
                    const importedData = JSON.parse(importTextarea.value);
                    if (typeof importedData === 'object' && importedData !== null) {
                        users = importedData;
                        saveUsers();
                        showLeaderboard();
                        const importModal = document.getElementById('import-modal');
                        if (importModal) importModal.style.display = 'none';
                        alert("Data imported successfully!");
                    } else { alert("Invalid JSON format. Please paste valid data."); }
                } catch (e) { alert("Error importing data. Please check the JSON format."); }
            });

            function copyToClipboard(elementId) {
                const textarea = document.getElementById(elementId);
                if (!textarea) return;
                textarea.select();
                document.execCommand('copy');
                alert("Copied to clipboard!");
            }

            const storedChallenge = localStorage.getItem('dailyChallenge');
            if (storedChallenge) {
                const parsedChallenge = JSON.parse(storedChallenge);
                const today = new Date().toISOString().slice(0, 10);
                if (parsedChallenge.date === today) {
                    Object.assign(dailyChallengeData, parsedChallenge);
                }
            }
            
            // This is a common point of failure. The tryPlayAudio() function assumes that the 'music-toggle' element exists
            // and is checked, but it might not be in the DOM yet when this function runs.
            // Wrapping the check with an if statement or optional chaining ensures it doesn't break the script.
            const musicToggle = document.getElementById('music-toggle');
            if (musicToggle) {
                musicToggle.checked = settings.musicOn;
            }

            // Correctly set UI colors on load based on settings
            document.documentElement.style.setProperty('--neon-pink', colorMap[settings.uiColor]);
            document.documentElement.style.setProperty('--light-red', colorMap[settings.uiColor]);

            showScreen('main-menu');
            updateDisplayUsername();
        });
    </script>
</body>
</html>